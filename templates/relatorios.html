{% extends "base.html" %}

{% block title %}Dashboard-TRONIK - Relat√≥rios{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relatorios.css') }}">
{% endblock %}

{% block content %}
<div class="relatorios-container">
    <!-- Left Panel -->
    <div class="relatorios-left-panel">
        <!-- Filters -->
        <div class="card" style="flex-shrink: 0;">
            <h3 class="card-header">Filtros do Relat√≥rio</h3>
            <div class="filters-compact">
                <div class="filter-group">
                    <div class="filter-label">Data In√≠cio</div>
                    <input type="date" class="filter-input" id="data-inicio" value="">
                </div>
                <div class="filter-group">
                    <div class="filter-label">Data Fim</div>
                    <input type="date" class="filter-input" id="data-fim" value="">
                </div>
                <button class="btn-primary" id="btn-aplicar-filtro" style="padding: 6px 12px; font-size: 11px;">
                    Aplicar
                </button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="card" style="flex-shrink: 0;">
            <h3 class="card-header">Indicadores do Per√≠odo</h3>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-total-coletas">0</div>
                    <div class="kpi-label">Total Coletas</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-volume-total">0</div>
                    <div class="kpi-label">Volume Total</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-eficiencia">0%</div>
                    <div class="kpi-label">Efici√™ncia</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-lixeiras-ativas">0</div>
                    <div class="kpi-label">Lixeiras Ativas</div>
                </div>
            </div>
        </div>

        <!-- Main Chart -->
        <div class="card" style="flex: 1;">
            <div class="chart-header">
                <h3 class="chart-title">Evolu√ß√£o de Coletas</h3>
                <div class="chart-tabs">
                    <button class="tab-btn" data-periodo="7">7 dias</button>
                    <button class="tab-btn active" data-periodo="30">30 dias</button>
                    <button class="tab-btn" data-periodo="90">90 dias</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="chart-evolucao"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card" style="flex: 1;">
            <h3 class="card-header">Detalhamento de Coletas</h3>
            <div class="table-container">
                <table id="relatorio-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>ID</th>
                            <th>Local</th>
                            <th>Volume</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="relatorio-tbody">
                        <tr>
                            <td colspan="5" style="text-align: center;">Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right Panel -->
    <div class="relatorios-right-panel">
        <!-- Summary -->
        <div class="card" style="flex: 1;">
            <h3 class="card-header">Resumo Executivo</h3>
            <div id="resumo-executivo">
                <div class="summary-box">
                    <div class="summary-title">Desempenho Geral</div>
                    <p id="resumo-desempenho">Selecione um per√≠odo para ver o resumo.</p>
                </div>
                <div class="summary-box" style="margin-top: 10px;">
                    <div class="summary-title">Pontos de Aten√ß√£o</div>
                    <p id="resumo-atencao">Nenhum ponto de aten√ß√£o no per√≠odo selecionado.</p>
                </div>
                <div class="summary-box" style="margin-top: 10px;">
                    <div class="summary-title">Recomenda√ß√µes</div>
                    <p id="resumo-recomendacoes">Analisando dados para gerar recomenda√ß√µes.</p>
                </div>
            </div>
        </div>
        
        <!-- Distribution Chart -->
            
<div class="card">
    <div class="chart-header">
        <h3 class="card-header">Distribui√ß√£o por Regi√£o</h3>

        <!-- Controles do gr√°fico -->
        <div class="chart-controls">
            <div class="control-group">
                <span class="control-label">Orienta√ß√£o:</span>
                <button
                    type="button"
                    class="chart-toggle-btn active"
                    id="btn-orientacao-vertical"
                    data-orientacao="vertical">
                    Vertical
                </button>
                <button
                    type="button"
                    class="chart-toggle-btn"
                    id="btn-orientacao-horizontal"
                    data-orientacao="horizontal">
                    Horizontal
                </button>
            </div>

            <div class="control-group">
                <span class="control-label">Ordem:</span>
                <button
                    type="button"
                    class="chart-toggle-btn active"
                    id="btn-ordem-desc"
                    data-ordem="desc">
                    Decrescente
                </button>
                <button
                    type="button"
                    class="chart-toggle-btn"
                    id="btn-ordem-asc"
                    data-ordem="asc">
                    Crescente
                </button>
            </div>
        </div>
    </div>

    <div class="chart-container-small">
        <canvas id="chart-distribuicao"></canvas>
    </div>
</div>


        <!-- Top Lixeiras -->
        <div class="card">
            <h3 class="card-header">Top 5 Lixeiras Mais Coletadas</h3>
            <div class="top-list" id="top-lixeiras">
                <p style="text-align: center; color: #7f8c8d; font-size: 12px;">Carregando...</p>
            </div>
        </div>

        <!-- Heatmap -->
        <div class="card">
            <h3 class="card-header">Hor√°rios de Pico</h3>
            <div class="chart-container-small">
                <canvas id="chart-horarios"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Verificar se Chart.js carregou
if (typeof Chart === 'undefined') {
    console.error('Chart.js n√£o foi carregado corretamente!');
}
// Vari√°veis globais para gr√°ficos
let chartEvolucao = null;
let chartDistribuicao = null;
let chartHorarios = null;

// Estado do gr√°fico de distribui√ß√£o (orienta√ß√£o e ordena√ß√£o)
let distribOrientacao = 'vertical'; // 'vertical' ou 'horizontal'
let distribOrdem = 'desc';          // 'asc' ou 'desc'

// Guarda os √∫ltimos dados usados para poder redesenhar o gr√°fico
let ultimoRelatorioDistribuicao = {
    coletasPorLixeira: [],
    lixeiras: []
};

function processarDadosDistribuicao(coletasPorLixeira, lixeiras, ordem = 'desc') {
    // Agrupar por regi√£o (usando parte do nome da localiza√ß√£o)
    const regioes = {};
    
    coletasPorLixeira.forEach(item => {
        const lixeira = lixeiras.find(l => l.id === item.lixeira_id);
        if (lixeira) {
            // Extrair regi√£o do nome (ex: "Asa Norte" de "Asa Norte - Bloco A")
            const regiao = lixeira.localizacao.split(' - ')[0] || 'Outros';
            if (!regioes[regiao]) {
                regioes[regiao] = 0;
            }
            regioes[regiao] += item.total_coletas;
        }
    });

    // Transforma em lista de { label, valor }
    let pares = Object.keys(regioes).map(regiao => ({
        label: regiao,
        valor: regioes[regiao]
    }));

    // Ordena crescente ou decrescente
    pares.sort((a, b) => {
        if (ordem === 'asc') {
            return a.valor - b.valor; // menor ‚Üí maior
        }
        return b.valor - a.valor;     // maior ‚Üí menor (padr√£o)
    });

    return {
        labels: pares.map(p => p.label),
        valores: pares.map(p => p.valor)
    };
}



// Fun√ß√£o para inicializar a p√°gina
function inicializarPagina() {
    // Verificar se Chart.js est√° dispon√≠vel
    if (typeof Chart === 'undefined') {
        console.error('Chart.js n√£o foi carregado! Verifique a conex√£o com o CDN.');
        // Tentar novamente ap√≥s 500ms
        setTimeout(inicializarPagina, 500);
        return;
    }
    
    // Configurar datas padr√£o para incluir os dados mock (janeiro a mar√ßo 2024)
    // Os dados mock est√£o entre 2024-01-02 e 2024-03-31
    // Vamos usar um per√≠odo que inclua esses dados
    const dataInicioEl = document.getElementById('data-inicio');
    const dataFimEl = document.getElementById('data-fim');
    
    if (dataInicioEl && dataFimEl) {
        // Se n√£o houver valor, usar per√≠odo dos dados mock (√∫ltimos 30 dias)
        if (!dataInicioEl.value || !dataFimEl.value) {
            const hoje = new Date('2024-03-31'); // Data fim dos dados mock
            const inicio = new Date(hoje);
            inicio.setDate(inicio.getDate() - 29); // 30 dias
            dataInicioEl.value = inicio.toISOString().split('T')[0];
            dataFimEl.value = hoje.toISOString().split('T')[0];
        }
    }
    
    // Bot√£o aplicar filtro
    const btnAplicar = document.getElementById('btn-aplicar-filtro');
    if (btnAplicar) {
        btnAplicar.addEventListener('click', carregarRelatorio);
    }
    
    // Tabs de per√≠odo
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Obter per√≠odo selecionado
            const periodo = parseInt(this.dataset.periodo);
            
            // Atualizar campos de data
            const dataInicioEl = document.getElementById('data-inicio');
            const dataFimEl = document.getElementById('data-fim');
            
            if (dataInicioEl && dataFimEl) {
                const dataMockFim = new Date('2024-03-31'); // Dados agora v√£o at√© 31/03
                const dataMockInicio = new Date('2024-01-02'); // Primeira coleta √© em 02/01
                
                // Determinar data fim: usar sempre o fim dos dados mock (31/03/2024)
                const dataFimAtual = new Date(dataMockFim);
                
                // Calcular nova data in√≠cio retrocedendo o per√≠odo a partir da data fim
                const novaDataInicio = new Date(dataFimAtual);
                novaDataInicio.setDate(novaDataInicio.getDate() - periodo + 1); // +1 para incluir o dia atual
                
                // L√≥gica diferenciada para cada per√≠odo:
                // - 7 dias: √∫ltimos 7 dias a partir da data fim
                // - 30 dias: √∫ltimos 30 dias a partir da data fim
                // - 90 dias: TODOS os dados dispon√≠veis (per√≠odo completo desde o in√≠cio)
                if (periodo >= 90) {
                    // 90 dias: mostrar TODOS os dados dispon√≠veis (per√≠odo completo desde o in√≠cio)
                    dataInicioEl.value = dataMockInicio.toISOString().split('T')[0];
                    dataFimEl.value = dataMockFim.toISOString().split('T')[0];
                } else if (periodo === 30) {
                    // 30 dias: mostrar exatamente 30 dias a partir da data fim
                    // Se o per√≠odo calculado vai antes do in√≠cio dos dados, limitar ao in√≠cio
                    if (novaDataInicio < dataMockInicio) {
                        // Per√≠odo maior que dados dispon√≠veis: mostrar todos os dados dispon√≠veis
                        dataInicioEl.value = dataMockInicio.toISOString().split('T')[0];
                        dataFimEl.value = dataFimAtual.toISOString().split('T')[0];
                    } else {
                        // Per√≠odo normal de 30 dias dentro dos dados dispon√≠veis
                        dataInicioEl.value = novaDataInicio.toISOString().split('T')[0];
                        dataFimEl.value = dataFimAtual.toISOString().split('T')[0];
                    }
                } else {
                    // 7 dias ou outros per√≠odos menores: calcular normalmente
                    if (novaDataInicio < dataMockInicio) {
                        dataInicioEl.value = dataMockInicio.toISOString().split('T')[0];
                    } else {
                        dataInicioEl.value = novaDataInicio.toISOString().split('T')[0];
                    }
                    dataFimEl.value = dataFimAtual.toISOString().split('T')[0];
                }
                
                console.log(`Per√≠odo ${periodo} dias: ${dataInicioEl.value} at√© ${dataFimEl.value}`);
                
                // Recarregar relat√≥rio com novas datas
                carregarRelatorio();
            }
        });
    });
    
    // Carregar relat√≥rio inicial
    carregarRelatorio();
}

// Aguardar DOM estar pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarPagina);
} else {
    // DOM j√° est√° pronto
    inicializarPagina();
}

// Fun√ß√£o para processar dados para gr√°fico de evolu√ß√£o
function processarDadosEvolucao(coletas) {
    // Agrupar coletas por data
    const coletasPorData = {};
    
    coletas.forEach(coleta => {
        const data = new Date(coleta.data_coleta);
        const dataStr = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        
        if (!coletasPorData[dataStr]) {
            coletasPorData[dataStr] = 0;
        }
        coletasPorData[dataStr]++;
    });
    
    // Ordenar por data
    const datas = Object.keys(coletasPorData).sort((a, b) => {
        const [diaA, mesA] = a.split('/');
        const [diaB, mesB] = b.split('/');
        return new Date(2024, mesA - 1, diaA) - new Date(2024, mesB - 1, diaB);
    });
    
    return {
        labels: datas,
        valores: datas.map(d => coletasPorData[d])
    };
}

// Fun√ß√£o para processar dados de distribui√ß√£o por regi√£o
function processarDadosDistribuicao(coletasPorLixeira, lixeiras) {
    // Agrupar por regi√£o (usando parte do nome da localiza√ß√£o)
    const regioes = {};
    
    coletasPorLixeira.forEach(item => {
        const lixeira = lixeiras.find(l => l.id === item.lixeira_id);
        if (lixeira) {
            // Extrair regi√£o do nome (ex: "Asa Norte" de "Asa Norte - Bloco A")
            const regiao = lixeira.localizacao.split(' - ')[0] || 'Outros';
            if (!regioes[regiao]) {
                regioes[regiao] = 0;
            }
            regioes[regiao] += item.total_coletas;
        }
    });
    
    return {
        labels: Object.keys(regioes),
        valores: Object.values(regioes)
    };
}

// Fun√ß√£o para processar dados de hor√°rios de pico
function processarDadosHorarios(coletas) {
    const horarios = Array(24).fill(0);
    
    coletas.forEach(coleta => {
        const data = new Date(coleta.data_coleta);
        const hora = data.getHours();
        horarios[hora]++;
    });
    
    return {
        labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}h`),
        valores: horarios
    };
}

// Fun√ß√£o para criar/atualizar gr√°fico de evolu√ß√£o
function atualizarGraficoEvolucao(dados) {
    const ctx = document.getElementById('chart-evolucao');
    
    if (!ctx) {
        console.error('Canvas chart-evolucao n√£o encontrado');
        return;
    }
    
    if (chartEvolucao) {
        chartEvolucao.destroy();
    }
    
    const processed = processarDadosEvolucao(dados.detalhes || []);
    
    // Se n√£o houver dados, mostrar gr√°fico vazio
    if (processed.labels.length === 0) {
        processed.labels = ['Sem dados'];
        processed.valores = [0];
    }
    
    try {
        chartEvolucao = new Chart(ctx, {
            type: 'line',
            data: {
                labels: processed.labels,
                datasets: [{
                    label: 'Coletas',
                    data: processed.valores,
                    borderColor: '#5DB5A4',
                    backgroundColor: 'rgba(93, 181, 164, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: processed.labels.length > 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao criar gr√°fico de evolu√ß√£o:', error);
    }
}

// Fun√ß√£o para criar/atualizar gr√°fico de distribui√ß√£o
function atualizarGraficoDistribuicao(coletasPorLixeira, lixeiras) {
    const ctx = document.getElementById('chart-distribuicao');
    
    if (!ctx) {
        console.error('Canvas chart-distribuicao n√£o encontrado');
        return;
    }
    
    if (chartDistribuicao) {
        chartDistribuicao.destroy();
    }

    // Guarda os dados pra reutilizar quando mudar orienta√ß√£o/ordem
    ultimoRelatorioDistribuicao = {
        coletasPorLixeira: coletasPorLixeira || [],
        lixeiras: lixeiras || []
    };
    
    const processed = processarDadosDistribuicao(
        ultimoRelatorioDistribuicao.coletasPorLixeira,
        ultimoRelatorioDistribuicao.lixeiras,
        distribOrdem // usa o estado global de ordena√ß√£o
    );
    
    // Se n√£o houver dados, mostra um gr√°fico "vazio"
    if (processed.labels.length === 0) {
        processed.labels = ['Sem dados'];
        processed.valores = [0];
    }
    
    try {
        chartDistribuicao = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: processed.labels,
                datasets: [{
                    label: 'Coletas por Regi√£o',
                    data: processed.valores,
                    backgroundColor: [
                        '#5DB5A4',
                        '#3498db',
                        '#f39c12',
                        '#e74c3c',
                        '#9b59b6',
                        '#1abc9c',
                        '#34495e'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                // üëá ISSO AQUI √â O QUE MUDA VERTICAL / HORIZONTAL
                indexAxis: distribOrientacao === 'horizontal' ? 'y' : 'x',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.formattedValue} coletas`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao criar gr√°fico de distribui√ß√£o:', error);
    }
}


// Fun√ß√£o para criar/atualizar gr√°fico de hor√°rios
function atualizarGraficoHorarios(coletas) {
    const ctx = document.getElementById('chart-horarios');
    
    if (!ctx) {
        console.error('Canvas chart-horarios n√£o encontrado');
        return;
    }
    
    if (chartHorarios) {
        chartHorarios.destroy();
    }
    
    const processed = processarDadosHorarios(coletas || []);
    
    try {
        chartHorarios = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: processed.labels,
                datasets: [{
                    label: 'Coletas',
                    data: processed.valores,
                    backgroundColor: '#5DB5A4',
                    borderColor: '#4A9B8E',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 8
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao criar gr√°fico de hor√°rios:', error);
    }
}

async function carregarRelatorio() {
    try {
        const dataInicio = document.getElementById('data-inicio').value;
        const dataFim = document.getElementById('data-fim').value;
        
        // Debug: verificar datas sendo enviadas
        console.log('Carregando relat√≥rio:', { dataInicio, dataFim });
        
        const relatorio = await obterRelatorios(dataInicio, dataFim);
        
        // Debug: verificar quantas coletas foram retornadas
        console.log('Coletas retornadas:', relatorio.detalhes.length);
        
        // Carregar lixeiras para gr√°fico de distribui√ß√£o
        const lixeiras = await obterTodasLixeiras();
        
        // Atualizar KPIs
        document.getElementById('kpi-total-coletas').textContent = relatorio.resumo.total_coletas || 0;
        document.getElementById('kpi-volume-total').textContent = 
            relatorio.resumo.volume_total ? Math.round(relatorio.resumo.volume_total) + 'L' : '0L';
        document.getElementById('kpi-eficiencia').textContent = 
            relatorio.resumo.total_coletas > 0 ? '95%' : '0%';
        document.getElementById('kpi-lixeiras-ativas').textContent = 
            relatorio.resumo.coletas_por_lixeira ? relatorio.resumo.coletas_por_lixeira.length : 0;
        
        // Sempre atualizar gr√°ficos com os dados filtrados
        atualizarGraficoEvolucao(relatorio);
        atualizarGraficoHorarios(relatorio.detalhes || []);
        
        // Gr√°fico de distribui√ß√£o s√≥ se houver coletas por lixeira
        if (relatorio.resumo && relatorio.resumo.coletas_por_lixeira) {
            atualizarGraficoDistribuicao(relatorio.resumo.coletas_por_lixeira, lixeiras);
        } else {
            atualizarGraficoDistribuicao([], lixeiras);
        }
        
        // Atualizar tabela
        const tbody = document.getElementById('relatorio-tbody');
        if (relatorio.detalhes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma coleta no per√≠odo</td></tr>';
        } else {
            tbody.innerHTML = relatorio.detalhes.map(coleta => {
                const data = new Date(coleta.data_coleta);
                return `
                    <tr>
                        <td>${data.toLocaleString('pt-BR')}</td>
                        <td>#L${String(coleta.id_lixeira).padStart(3, '0')}</td>
                        <td>Lixeira ${coleta.id_lixeira}</td>
                        <td>${coleta.volume_estimado ? Math.round(coleta.volume_estimado) + 'L' : 'N/A'}</td>
                        <td><span class="bin-status-badge status-ok">OK</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Atualizar top lixeiras
        const topList = document.getElementById('top-lixeiras');
        if (relatorio.resumo.coletas_por_lixeira && relatorio.resumo.coletas_por_lixeira.length > 0) {
            const top = relatorio.resumo.coletas_por_lixeira
                .sort((a, b) => b.total_coletas - a.total_coletas)
                .slice(0, 5);
            
            topList.innerHTML = top.map(item => `
                <div class="top-item">
                    <span class="top-name">#L${String(item.lixeira_id).padStart(3, '0')}</span>
                    <span class="top-value">${item.total_coletas} coletas</span>
                </div>
            `).join('');
        } else {
            topList.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 12px;">Nenhum dado dispon√≠vel</p>';
        }
        
        // Atualizar resumo executivo
        const eficiencia = relatorio.resumo.total_coletas > 0 ? '95%' : '0%';
        const volumeTotal = Math.round(relatorio.resumo.volume_total || 0);
        
        document.getElementById('resumo-desempenho').textContent = 
            `Efici√™ncia de ${eficiencia} com ${relatorio.resumo.total_coletas} coletas e volume total de ${volumeTotal}L no per√≠odo selecionado.`;
        
        // Pontos de aten√ß√£o
        const lixeirasComProblemas = relatorio.resumo.coletas_por_lixeira 
            ? relatorio.resumo.coletas_por_lixeira.filter(l => l.total_coletas > 10).length 
            : 0;
        
        if (lixeirasComProblemas > 0) {
            document.getElementById('resumo-atencao').textContent = 
                `${lixeirasComProblemas} lixeira(s) com alto n√∫mero de coletas no per√≠odo. Verifique necessidade de otimiza√ß√£o de rotas.`;
        } else {
            document.getElementById('resumo-atencao').textContent = 
                'Nenhum ponto de aten√ß√£o cr√≠tico no per√≠odo selecionado.';
        }
        
        // Recomenda√ß√µes
        if (relatorio.resumo.total_coletas > 50) {
            document.getElementById('resumo-recomendacoes').textContent = 
                'Aumentar frequ√™ncia nas lixeiras cr√≠ticas. Implementar coletas preventivas nos hor√°rios de pico.';
        } else if (relatorio.resumo.total_coletas > 0) {
            document.getElementById('resumo-recomendacoes').textContent = 
                'Monitorar padr√µes de coleta para identificar hor√°rios de pico e otimizar rotas.';
        } else {
            document.getElementById('resumo-recomendacoes').textContent = 
                'Selecione um per√≠odo com dados para gerar recomenda√ß√µes.';
        }
        
    } catch (error) {
        console.error('Erro ao carregar relat√≥rio:', error);
        alert('Erro ao carregar relat√≥rio.');
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const btnVert = document.getElementById('btn-orientacao-vertical');
    const btnHor  = document.getElementById('btn-orientacao-horizontal');
    const btnAsc  = document.getElementById('btn-ordem-asc');
    const btnDesc = document.getElementById('btn-ordem-desc');

    function atualizarBotoesOrientacao() {
        if (!btnVert || !btnHor) return;
        btnVert.classList.toggle('active', distribOrientacao === 'vertical');
        btnHor.classList.toggle('active', distribOrientacao === 'horizontal');
    }

    function atualizarBotoesOrdem() {
        if (!btnAsc || !btnDesc) return;
        btnAsc.classList.toggle('active', distribOrdem === 'asc');
        btnDesc.classList.toggle('active', distribOrdem === 'desc');
    }

    function redesenharGraficoDistribuicaoSePossivel() {
        if (ultimoRelatorioDistribuicao.lixeiras.length > 0 ||
            ultimoRelatorioDistribuicao.coletasPorLixeira.length > 0) {
            atualizarGraficoDistribuicao(
                ultimoRelatorioDistribuicao.coletasPorLixeira,
                ultimoRelatorioDistribuicao.lixeiras
            );
        }
    }

    if (btnVert && btnHor) {
        btnVert.addEventListener('click', function () {
            distribOrientacao = 'vertical';
            atualizarBotoesOrientacao();
            redesenharGraficoDistribuicaoSePossivel();
        });

        btnHor.addEventListener('click', function () {
            distribOrientacao = 'horizontal';
            atualizarBotoesOrientacao();
            redesenharGraficoDistribuicaoSePossivel();
        });
    }

    if (btnAsc && btnDesc) {
        btnAsc.addEventListener('click', function () {
            distribOrdem = 'asc';
            atualizarBotoesOrdem();
            redesenharGraficoDistribuicaoSePossivel();
        });

        btnDesc.addEventListener('click', function () {
            distribOrdem = 'desc';
            atualizarBotoesOrdem();
            redesenharGraficoDistribuicaoSePossivel();
        });
    }

    // Deixa os bot√µes marcados de acordo com o estado inicial
    atualizarBotoesOrientacao();
    atualizarBotoesOrdem();
});

</script>
{% endblock %}

